<!doctype html>
<html lang="vi">
<head>
  <meta charset="utf-8" />
  <title>TradingView Pro Capture</title>
  <meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
  <meta name="color-scheme" content="dark light" />
  <link rel="preconnect" href="https://fonts.googleapis.com" />
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Space+Grotesk:wght@400;600;700&display=swap" rel="stylesheet" />
  <style>
    :root{
      --bg:#0b0e13; --panel:#0f1520; --elev:#111927;
      --stroke:#1b2533; --muted:#8b93a7; --text:#e7ebf3;
      --brand:#6e9bff; --brand2:#5ad1b8; --warn:#ffaa00; --ok:#24d69a; --err:#ff5a64;
      --r:14px; --r-lg:18px; --shadow:0 10px 30px rgba(0,0,0,.25);
    }
    @media (prefers-color-scheme:light){
      :root{ --bg:#f6f8fb; --panel:#ffffff; --elev:#ffffff; --stroke:#e5e9f0; --muted:#5d677d; --text:#0e1420; --shadow:0 10px 30px rgba(0,0,0,.08); }
    }
    *{box-sizing:border-box} html{scroll-behavior:smooth}
    body{
      margin:0; color:var(--text);
      background: radial-gradient(900px 520px at -10% -10%, rgba(110,155,255,.12), transparent),
                  radial-gradient(900px 520px at 110% 0%,  rgba(90,209,184,.10), transparent),
                  var(--bg);
      font:15px/1.55 "Space Grotesk", ui-sans-serif, system-ui, -apple-system, "Segoe UI", Roboto, Arial;
      -webkit-font-smoothing:antialiased; -moz-osx-font-smoothing:grayscale;
    }
    .wrap{max-width:1120px;margin:0 auto;padding:22px 16px 72px}
    header{position:sticky;top:0;z-index:50;padding:12px 0;background:linear-gradient(to bottom, rgba(0,0,0,.2), transparent);backdrop-filter:saturate(150%) blur(12px)}
    .head{display:flex;align-items:center;justify-content:space-between;gap:12px;flex-wrap:wrap}
    .brand{display:flex;align-items:center;gap:12px}
    .logo{width:40px;height:40px;border-radius:12px;background:conic-gradient(from 160deg, var(--brand), var(--brand2));box-shadow:inset 0 0 0 4px rgba(255,255,255,.06)}
    h1{margin:0;font-weight:900;letter-spacing:.2px;font-size:clamp(22px,4.2vw,28px);background:linear-gradient(90deg,var(--brand),var(--brand2));-webkit-background-clip:text;background-clip:text;color:transparent}
    .status{display:flex;gap:8px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;padding:8px 12px;border-radius:999px;background:linear-gradient(180deg,var(--panel),var(--elev));border:1px solid var(--stroke);box-shadow:var(--shadow);font-weight:700;font-size:13px;color:var(--muted);text-decoration:none}
    .dot{width:8px;height:8px;border-radius:50%}
    .dot.ok{background:var(--ok);box-shadow:0 0 10px var(--ok)}
    .dot.warn{background:var(--warn);box-shadow:0 0 10px var(--warn)}
    .dot.err{background:var(--err);box-shadow:0 0 10px var(--err)}

    .card{margin:14px 0;padding:18px 18px 20px;border-radius:var(--r-lg);background:linear-gradient(180deg,var(--panel),var(--elev));border:1px solid var(--stroke);box-shadow:var(--shadow)}
    .card h2{margin:0 0 8px;font-size:18px;letter-spacing:.2px}
    .sub{color:var(--muted);font-size:13px}

    /* quick actions */
    .actions-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:10px;margin-top:12px}
    .qa{display:flex;align-items:center;gap:10px;padding:12px;border-radius:14px;background:linear-gradient(180deg, rgba(255,255,255,.06), rgba(0,0,0,.06));border:1px solid var(--stroke);text-decoration:none;color:var(--text);font-weight:800}
    .qa:hover{transform:translateY(-2px);transition:transform .08s ease;border-color:rgba(110,155,255,.7)}
    .qa .dot{background:radial-gradient(circle at 30% 30%, var(--brand2), var(--brand));box-shadow:0 0 8px var(--brand)}

    /* form */
    .seg{display:inline-flex;background:rgba(255,255,255,.05);border:1px solid var(--stroke);border-radius:12px;padding:4px;gap:4px;margin:6px 0 10px}
    .seg button{appearance:none;border:0;cursor:pointer;border-radius:10px;padding:8px 12px;font-weight:900;color:var(--muted);background:transparent}
    .seg [aria-pressed="true"]{background:linear-gradient(180deg, rgba(255,255,255,.14), rgba(255,255,255,.06));color:var(--text);box-shadow:inset 0 1px 0 rgba(255,255,255,.08), 0 6px 16px rgba(0,0,0,.25)}
    .grid{display:grid;grid-template-columns:repeat(2,minmax(220px,1fr));gap:10px}
    @media (max-width:720px){.grid{grid-template-columns:1fr}}
    label{display:block;font-size:12px;font-weight:900;color:var(--muted);margin:6px 2px}
    input{width:100%;padding:12px 14px;border-radius:12px;border:1px solid var(--stroke);background:rgba(255,255,255,.06);color:var(--text);font-weight:700;outline:none}
    input:focus{border-color:rgba(110,155,255,.7);box-shadow:0 0 0 4px rgba(110,155,255,.14)}

    .btns{display:flex;flex-wrap:wrap;gap:8px;margin-top:12px}
    .btn{appearance:none;border:1px solid var(--stroke);cursor:pointer;text-decoration:none;padding:12px 14px;border-radius:14px;font-weight:900;letter-spacing:.2px;color:#fff;background:linear-gradient(180deg,var(--brand),#4a7bf9);box-shadow:0 12px 28px rgba(110,155,255,.35);display:inline-flex;align-items:center;gap:8px}
    .btn.ghost{background:transparent;color:var(--text)}
    .btn.sec{background:linear-gradient(180deg,rgba(255,255,255,.12),rgba(255,255,255,.04));color:var(--text)}

    .code{background:linear-gradient(180deg,rgba(0,0,0,.35),rgba(0,0,0,.25));border:1px solid var(--stroke);border-radius:12px;padding:10px 12px;font-family:"JetBrains Mono",ui-monospace,Menlo,Consolas,monospace;font-size:13px;color:#d1d7e3;overflow:auto;white-space:nowrap;margin-top:10px}
    .success{color:var(--ok)} .error{color:var(--err)}
  </style>
</head>
<body>
  <header>
    <div class="wrap head">
      <div class="brand">
        <div class="logo" aria-hidden="true"></div>
        <h1>TradingView Pro</h1>
      </div>
      <div class="status">
        <a id="healthLink" class="pill" href="#" target="_blank" rel="noopener">
          <span class="dot warn"></span><span id="healthText">Đang kiểm tra…</span>
        </a>
      </div>
    </div>
  </header>

  <main class="wrap">
    <!-- Quick actions -->
    <section class="card">
      <h2>Capture nhanh</h2>
      <div class="sub">Chụp chart phổ biến. Mặc định: OANDA:XAUUSD • fit + pan 50 ➜ + crop.</div>
      <div id="qa" class="actions-grid" style="margin-top:10px"></div>
    </section>

    <!-- Custom -->
    <section class="card">
      <h2>Tùy chỉnh</h2>
      <div class="seg" role="tablist" aria-label="Timeframe">
        <button type="button" class="tf" data-tf="M5"  aria-pressed="false">M5</button>
        <button type="button" class="tf" data-tf="M15" aria-pressed="false">M15</button>
        <button type="button" class="tf" data-tf="M30" aria-pressed="false">M30</button>
        <button type="button" class="tf" data-tf="H1"  aria-pressed="true">H1</button>
        <button type="button" class="tf" data-tf="H4"  aria-pressed="false">H4</button>
        <button type="button" class="tf" data-tf="D"   aria-pressed="false">D1</button>
        <button type="button" class="tf" data-tf="W"   aria-pressed="false">W1</button>
      </div>

      <div class="grid">
        <div>
          <label for="timeframe">Timeframe</label>
          <input id="timeframe" value="H1" />
        </div>
        <div>
          <label for="ticker">Ticker</label>
          <input id="ticker" value="OANDA:XAUUSD" placeholder="OANDA:XAUUSD, NASDAQ:AAPL, ..." />
        </div>
        <div>
          <label for="w">Width (px)</label>
          <input id="w" type="number" value="1440" min="320" />
        </div>
        <div>
          <label for="h">Height (px)</label>
          <input id="h" type="number" value="900" min="320" />
        </div>
      </div>

      <div class="btns">
        <button id="btnDownload" class="btn" type="button">Tải PNG</button>
        <button id="btnCopy" class="btn sec" type="button">Copy cURL</button>
        <a id="btnOpen" class="btn ghost" href="#" rel="noopener">Mở tab mới</a>
      </div>

      <div id="urlBox" class="code">URL sẽ hiển thị ở đây…</div>
    </section>

    <!-- Examples -->
    <section class="card">
      <h2>Ví dụ</h2>
      <div class="sub">Sử dụng API bằng PowerShell, cURL, Node, Python…</div>
      <div id="ex-ps" class="code" style="margin-top:10px"></div>
      <div id="ex-curl" class="code" style="margin-top:8px"></div>
      <div id="ex-node" class="code" style="margin-top:8px"></div>
      <div id="ex-py" class="code" style="margin-top:8px;white-space:pre"></div>
    </section>
  </main>

  <script>
    (function(){
      const $ = s => document.querySelector(s);
      const $$ = s => Array.from(document.querySelectorAll(s));
      const byId = id => document.getElementById(id);

      // ==== CONFIG: API base =====
      const DEFAULT_API = 'https://tradingviewcapture-721483185057.asia-southeast1.run.app';
      const urlq = new URL(location.href);
      const API_BASE = urlq.searchParams.get('api') || DEFAULT_API;

      // ==== Build URLs ====
      function buildCaptureURL(tf, ticker, w, h){
        const p = new URLSearchParams();
        p.set('tf', (tf||'H1').toUpperCase());
        if (ticker && ticker.trim()) p.set('ticker', ticker.trim());
        p.set('w', String(Math.max(320, +w||1440)));
        p.set('h', String(Math.max(320, +h||900)));
        return `${API_BASE}/capture?${p.toString()}`;
      }

      function updateHealth(){
        const link = byId('healthLink');
        const text = byId('healthText');
        link.href = `${API_BASE}/health`;
        fetch(`${API_BASE}/health`, {cache:'no-store'})
          .then(r => r.json().catch(()=>({})).then(data => ({ok:r.ok,data})))
          .then(({ok,data})=>{
            link.querySelector('.dot').className = 'dot ' + (ok?'ok':'err');
            text.textContent = ok ? 'Online' : 'Offline';
            if (data?.time) text.textContent += ' • ' + new Date(data.time).toLocaleTimeString();
          })
          .catch(()=>{
            link.querySelector('.dot').className = 'dot err';
            text.textContent = 'Offline';
          });
      }

      // ==== Quick actions ====
      function renderQuick(){
        const qa = byId('qa');
        const pairs = [
          {tf:'M5',  label:'5 phút'},
          {tf:'M15', label:'15 phút'},
          {tf:'H1',  label:'1 giờ'},
          {tf:'H4',  label:'4 giờ'},
          {tf:'D',   label:'1 ngày'},
          {tf:'W',   label:'1 tuần'},
        ];
        qa.innerHTML = '';
        for (const it of pairs){
          const a = document.createElement('a');
          a.className = 'qa';
          a.href = buildCaptureURL(it.tf, 'OANDA:XAUUSD', 1440, 900);
          a.target = '_blank'; a.rel = 'noopener';
          a.innerHTML = `<span class="dot"></span><span>${it.label}</span>`;
          qa.appendChild(a);
        }
      }

      // ==== Custom form state ====
      const state = { tf:'H1', ticker:'OANDA:XAUUSD', w:1440, h:900 };

      function syncFromInputs(){
        state.tf     = (byId('timeframe').value || 'H1').toUpperCase();
        state.ticker = byId('ticker').value || 'OANDA:XAUUSD';
        state.w      = Math.max(320, parseInt(byId('w').value||'1440',10));
        state.h      = Math.max(320, parseInt(byId('h').value||'900',10));
        renderUrlBox();
      }
      function setInputs(){
        byId('timeframe').value = state.tf;
        byId('ticker').value = state.ticker;
        byId('w').value = state.w;
        byId('h').value = state.h;
      }
      function renderUrlBox(){
        const url = buildCaptureURL(state.tf, state.ticker, state.w, state.h);
        byId('urlBox').textContent = url;
        renderExamples(url);
        return url;
      }

      // segmented TF
      $$('.tf').forEach(b=>{
        b.addEventListener('click', ()=>{
          $$('.tf').forEach(x=>x.setAttribute('aria-pressed','false'));
          b.setAttribute('aria-pressed','true');
          state.tf = b.dataset.tf.toUpperCase();
          setInputs(); renderUrlBox();
        });
      });

      // inputs
      ['timeframe','ticker','w','h'].forEach(id=>{
        const el = byId(id);
        el.addEventListener('input', syncFromInputs);
        el.addEventListener('change', syncFromInputs);
      });

      // buttons
      byId('btnDownload').addEventListener('click', e=>{
        e.preventDefault();
        const url = renderUrlBox();
        // điều hướng để trình duyệt tải/hiện ảnh (server set Content-Disposition)
        window.location.href = url;
      });
      byId('btnOpen').addEventListener('click', e=>{
        e.preventDefault();
        window.open(renderUrlBox(), '_blank', 'noopener');
      });
      byId('btnCopy').addEventListener('click', async e=>{
        e.preventDefault();
        const url = renderUrlBox();
        const cmd = `curl -L "${url}" -o "chart.png"`;
        try{
          await navigator.clipboard.writeText(cmd);
          byId('urlBox').textContent = '✅ Đã copy: ' + cmd;
          byId('urlBox').classList.remove('error'); byId('urlBox').classList.add('success');
          setTimeout(renderUrlBox, 2000);
        }catch{
          // fallback: select text
          const sel = window.getSelection(); const r = document.createRange();
          r.selectNodeContents(byId('urlBox')); sel.removeAllRanges(); sel.addRange(r);
          byId('urlBox').classList.remove('success'); byId('urlBox').classList.add('error');
          setTimeout(()=>byId('urlBox').classList.remove('error'), 1500);
        }
      });

      // examples
      function renderExamples(url){
        byId('ex-ps').textContent   = `Invoke-WebRequest "${url}" -OutFile "chart.png"`;
        byId('ex-curl').textContent = `curl -L "${url}" -o "chart.png"`;
        byId('ex-node').textContent =
`import fs from 'fs';
const res = await fetch("${url}");
if (!res.ok) throw new Error(res.status+" "+res.statusText);
const buf = Buffer.from(await res.arrayBuffer());
fs.writeFileSync("chart.png", buf);`;
        byId('ex-py').textContent =
`import requests
r = requests.get("${url}")
open("chart.png","wb").write(r.content)`;
      }

      // init
      updateHealth();
      renderQuick();
      setInputs();
      renderUrlBox();
    })();
  </script>
</body>
</html>
